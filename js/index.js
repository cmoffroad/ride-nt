function C(){return location.protocol.startsWith("file")}const D="UmlkZVNhZmUyMDI1IQ==",$="rident_auth",F=30*24*60*60*1e3;function V(){const e=localStorage.getItem($);if(!e)return!1;try{const{password:d,expires:t}=JSON.parse(e);return d===D&&Date.now()<t}catch{return!1}}function H(){const e=Date.now()+F;localStorage.setItem($,JSON.stringify({password:D,expires:e}))}function M(){V()||(prompt("Enter password to view the map:")!==atob(D)&&(alert("Incorrect password. Access denied."),document.body.innerHTML="<h2 style='text-align:center;margin-top:20%'>Access Denied</h2>"),H()),document.body.classList.remove("locked")}const k={minLat:16.5,maxLat:20.5,minLon:97.5,maxLon:103},_=[[k.minLat,k.minLon],[k.maxLat,k.maxLon]],v={fast:"rgba(0, 140, 60, 1)",moderate:"rgba(255, 179, 0, 1)",slow:"rgba(255, 40, 40, 1)",veryTechnical:"rgba(128, 0, 128, 1)",maybe:"rgba(180, 180, 180, 1)",likely:"rgba(100, 100, 100, 1)",paved:"rgba(51, 102, 255, 1)"},j=1752506058100,B=L.tileLayer(`https://julcnx.github.io/tiles/heatmap/ride/{z}/{x}/{y}.png?ts=${j}`,{tileSize:256,minNativeZoom:10,maxNativeZoom:13,zIndex:3}),I={satellite:"s",terrain:"p",hybrid:"h",maps:"m"},K=L.tileLayer(`https://mt{s}.google.com/vt?lyrs=${I.satellite}&x={x}&y={y}&z={z}`,{subdomains:["0","1","2","3"],maxNativeZoom:18}),Y=L.tileLayer(`https://mt{s}.google.com/vt?lyrs=${I.maps}&x={x}&y={y}&z={z}`,{subdomains:["0","1","2","3"],maxNativeZoom:18}),q=L.tileLayer(`https://mt{s}.google.com/vt?lyrs=${I.terrain}&x={x}&y={y}&z={z}`,{subdomains:["0","1","2","3"],maxNativeZoom:18}),J=L.tileLayer(`https://mt{s}.google.com/vt?lyrs=${I.hybrid}&x={x}&y={y}&z={z}`,{subdomains:["0","1","2","3"],maxNativeZoom:18,transparent:!0,zIndex:2}),X=L.esri.basemapLayer("ImageryFirefly",{maxNativeZoom:18}),Q=L.esri.basemapLayer("ImageryClarity",{maxNativeZoom:17}),ee=L.tileLayer("https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/WMTS/1.0.0/default028mm/MapServer/tile/10/{z}/{y}/{x}",{maxNativeZoom:17}),te=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{subdomains:["a","b","c"]}),oe=L.tileLayer("https://services.arcgisonline.com/arcgis/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{maxNativeZoom:18}),ne=L.tileLayer("./50k/{z}/{x}/{y}.png",{attribution:"50K",minNativeZoom:13,maxNativeZoom:14}),ae=L.tileLayer("https://mts{s}.googleapis.com/vt?hl=en-US&lyrs=svv|cb_client:apiv3&style=40,18&x={x}&y={y}&z={z}",{subdomains:["0","1","2","3"],maxNativeZoom:13,maxZoom:20,zIndex:1,className:"overlay"}),se=L.vectorGrid.protobuf("https://tiles.mapillary.com/maps/vtp/mly1_public/2/{z}/{x}/{y}?access_token=MLY|4100327730013843|5bb78b81720791946a9a7b956c57b7cf",{transparent:!0,maxNativeZoom:13,zIndex:1,className:"overlay",vectorTileLayerStyles:{sequence:()=>({color:"rgb(20, 150, 60)",weight:10})}}),le=L.tileLayer("https://karta-gateway.geo.azure.myteksi.net/view/api/2.0/sequence/tiles/{x}/{y}/{z}.png",{transparent:!0,minNativeZoom:13,maxNativeZoom:20,className:"overlay"}),re=L.tileLayer("https://content-{s}.strava.com/identified/globalheat/all/hot/{z}/{x}/{y}.png?v=19",{subdomains:["a"],maxNativeZoom:15,zIndex:2,className:"overlay"}),ie=L.tileLayer("https://{s}.gps-tile.openstreetmap.org/lines/{z}/{x}/{y}.png",{transparent:!0,maxNativeZoom:18,zIndex:2,className:"overlay"}),E={"World Topo Map":oe,"OSM Standard":te,"Google Maps":Y,"Google Terrain":q};C()&&(E["RTS Map"]=ne);const N={"Google Satellite":K,"ESRI Firefly":X,"ESRI Clarity":Q,"ESRI Wayback":ee},h={"OpenStreetMap traces":ie};C()&&(h["Google Street View"]=ae,h["Google Hybrid"]=J,h.Mapillary=se,h.KartaView=le,h["Strava Heatmap"]=re);let x=0;function ce(e,d,t,n){const a=L.control({position:"topleft"});a.onAdd=function(){const o=L.DomUtil.create("div","leaflet-control leaflet-top-center leaflet-control-layers leaflet-control-layers-expanded transparency-toolbar"),p=L.DomUtil.create("select","",o);p.className="transparency-select",Object.keys(n).forEach(m=>{const u=document.createElement("option");u.value=m,u.textContent=m,p.appendChild(u)});const l=localStorage.getItem("rident_satellite"),i=l&&n[l]?l:Object.keys(n)[0];p.value=i;let r=n[i];r.addTo(e),r.setOpacity(x/100),r.setZIndex(1);const c=L.DomUtil.create("input","",o);return c.className="transparency-slider",c.type="range",c.min=0,c.max=100,c.step=1,c.value=x,L.DomEvent.on(c,"input",m=>{x=parseFloat(m.target.value),r&&r.setOpacity(x/100),c.blur()}),L.DomEvent.on(p,"change",m=>{const u=m.target.value;e.hasLayer(r)&&e.removeLayer(r),r=n[u],r.addTo(e),r.setOpacity(x/100),r.setZIndex(1),localStorage.setItem("rident_satellite",u)}),L.DomEvent.disableClickPropagation(o),p.blur(),o},a.addTo(e)}const A="rident_map_view",G="rident_base_layer",R="rident_satellite",U="rident_overlays";function de(){document.getElementById("map").style.display="block";const e=pe();ye(e);const d=L.control.layers(E,h,{collapsed:!0,autoZIndex:!1,position:"topright"}).addTo(e),t=me(e,E,h,N);return ue(e,E,h),{map:e,mainOverlay:B,baseLayers:E,satelliteLayers:N,overlays:h,currentBaseLayer:t,layersControl:d}}function pe(){return L.map("map",{minZoom:9,maxBounds:L.latLngBounds(_),layers:[B],zoomControl:!0,maxZoom:18,attributionControl:!1})}function ye(e){const d=location.hash.match(/^#(\d+)\/([-\d.]+)\/([-\d.]+)$/);if(d){const n=+d[1],a=+d[2],o=+d[3];e.setView([a,o],n);return}const t=localStorage.getItem(A);if(t)try{const{center:n,zoom:a}=JSON.parse(t);e.setView(n,a);return}catch{}e.setView([18.79,98.98],10)}function me(e,d,t,n){let a;const o=localStorage.getItem(G);o&&d[o]?(d[o].addTo(e),a=d[o]):(d["World Topo Map"].addTo(e),a=d["World Topo Map"]);const p=localStorage.getItem(U);let l=[];try{l=p?JSON.parse(p):[]}catch{}if(l.length)for(const[c,m]of Object.entries(t))l.includes(c)&&m.addTo(e);const i=localStorage.getItem(R);let r;return i&&n[i]?r=n[i]:r=n["Google Satellite"],r&&(r.setOpacity(x/100),r.addTo(e)),a}function ue(e,d,t){e.on("baselayerchange",n=>{const a=Object.entries(d).find(([p,l])=>l===n.layer);a&&(localStorage.setItem(G,a[0]),a[1].setZIndex(0));const o=Object.entries(N).find(([p,l])=>l===n.layer);o&&(localStorage.setItem(R,o[0]),o[1].setZIndex(1),o[1].setOpacity(x/100))}),e.on("overlayadd overlayremove",()=>{const n=Object.entries(t).filter(([a,o])=>e.hasLayer(o)).map(([a])=>a);localStorage.setItem(U,JSON.stringify(n))}),e.on("moveend zoomend",()=>{const n=e.getCenter(),a=e.getZoom(),o=`#${a}/${n.lat.toFixed(6)}/${n.lng.toFixed(6)}`;location.hash=o,localStorage.setItem(A,JSON.stringify({center:n,zoom:a}))})}function ge(e){const d=L.control({position:"bottomright"});d.onAdd=function(){const t=L.DomUtil.create("div","info legend");t.style.position="relative",t.style.transition="all 0.3s ease",t.style.fontSize="14px",t.style.color="#333",t.style.maxWidth="250px";let n=!1;function a(u){return`<span style="
				display:inline-block;
				width:14px;
				height:10px;
				margin-right:8px;
				background-color:${u};
				vertical-align:middle;
			"></span>`}const o=document.createElement("div");o.style.background="rgba(255, 255, 255, 0.95)",o.style.borderRadius="6px",o.style.padding="8px",o.style.boxShadow="0 2px 6px rgba(0,0,0,0.2)",o.style.display="none",o.style.flexDirection="column";const p=document.createElement("div");p.style.display="flex",p.style.justifyContent="space-between",p.style.alignItems="center",p.style.marginBottom="6px";const l=document.createElement("span");l.textContent="RideNT Legend",l.style.fontWeight="bold";const i=document.createElement("a");i.href="#",i.innerHTML="🔽",i.title="Collapse legend",i.style.fontSize="18px",i.style.textDecoration="none",i.style.cursor="pointer",i.style.padding="4px",i.onclick=u=>{u.preventDefault(),n=!1,m()},p.appendChild(l),p.appendChild(i);const r=document.createElement("div");r.innerHTML=`
			${a(v.paved)} Paved<br>
			${a(v.fast)} Fast dirt<br>
			${a(v.moderate)} Moderate dirt<br>
			${a(v.slow)} Slow / Technical<br>
			${a(v.veryTechnical)} Very technical<br>
			${a(v.likely)} Rural roads<br>
			${a(v.maybe)} Uncertain trails<br>
			<br>
			<span class="caption">Speeds are approximate, based on dry GPX tracks with climate & rider factors considered. Accuracy not guaranteed.</span>
		`,o.appendChild(p),o.appendChild(r);const c=document.createElement("a");c.href="#",c.innerHTML="❓",c.title="Show legend",c.style.display="none",c.style.textDecoration="none",c.style.fontSize="20px",c.style.width="36px",c.style.height="36px",c.style.textAlign="center",c.style.lineHeight="36px",c.style.borderRadius="6px",c.style.background="white",c.style.boxShadow="0 2px 6px rgba(0,0,0,0.2)",c.style.cursor="pointer",c.onclick=u=>{u.preventDefault(),n=!0,m()};function m(){o.style.display=n?"flex":"none",c.style.display=n?"none":"inline-block"}return m(),t.appendChild(o),t.appendChild(c),t},d.addTo(e)}function Z(e,d=2e3){const t=document.createElement("div");t.innerText=e,t.style.position="fixed",t.style.bottom="20px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.background="rgba(0,0,0,0.8)",t.style.color="#fff",t.style.padding="8px 12px",t.style.borderRadius="6px",t.style.fontSize="14px",t.style.zIndex=9999,t.style.opacity=0,t.style.transition="opacity 0.3s ease",document.body.appendChild(t),requestAnimationFrame(()=>{t.style.opacity=1}),setTimeout(()=>{t.style.opacity=0,setTimeout(()=>{document.body.removeChild(t)},300)},d)}function fe(e,d,t){const n=document.getElementById("context-menu");function a(l,i){const r=document.createElement("div");r.innerText=l,r.style.padding="4px 8px",r.style.cursor="pointer",r.onmouseenter=()=>r.style.background="#eee",r.onmouseleave=()=>r.style.background="",r.onmousedown=()=>{i(),n.style.display="none"},n.appendChild(r)}function o(){const l=document.createElement("hr");l.style.margin="0",n.appendChild(l)}e.on("contextmenu",function(l){const i=l.latlng.lat.toFixed(6),r=l.latlng.lng.toFixed(6),c=e.getZoom();n.innerHTML="",a("Edit in OpenStreetMap",()=>{window.open(`https://www.openstreetmap.org/id?#map=${Math.max(16,e.getZoom())}/${i}/${r}`)}),o(),a("Open in Google Maps",()=>{const m=t===d["Google Satellite"],u=new URLSearchParams({api:1,map_action:"map",basemap:m?"satellite":"terrain",center:[i,r].join(","),zoom:c});window.open(`https://www.google.com/maps/@?${unescape(u)}`)}),a("Open in Google Street View",()=>{window.open(`https://www.google.com/maps?q=&layer=c&cbll=${i},${r}`)}),a("Open in Komoot",()=>{window.open(`https://www.komoot.com/plan/@${i},${r},${c}z?sport=mtb`)}),C()&&a("Open in Mapillary",()=>{const m=new URLSearchParams({lat:i,lng:r,z:c});window.open(`https://www.mapillary.com/app/?${unescape(m)}`)}),o(),a("Copy Coordinates",()=>{navigator.clipboard.writeText(`${i}, ${r}`).then(()=>{Z("Coordinates copied to clipboard.")})}),a("Copy Bounding Box",()=>{const m=e.getBounds(),u=m.getSouth().toFixed(6),w=m.getEast().toFixed(6),T=m.getNorth().toFixed(6),z=m.getWest().toFixed(6),s=`${T},${z},${u},${w}`;navigator.clipboard.writeText(s).then(()=>{Z("Bounding box copied to clipboard.")})}),n.style.left=l.originalEvent.pageX+"px",n.style.top=l.originalEvent.pageY+"px",n.style.display="block"});const p=()=>n.style.display="none";e.on("mousedown",p),document.addEventListener("mousedown",p)}function he(e,d,t={}){const n=e.getContainer(),a=L.latLngBounds(_);["dragenter","dragover","dragleave","drop"].forEach(o=>{n.addEventListener(o,p=>p.preventDefault(),!1)}),n.addEventListener("drop",o=>{if(o.preventDefault(),!!o.dataTransfer.files.length)for(const p of o.dataTransfer.files){if(!p.name.toLowerCase().endsWith(".gpx"))continue;const l=new FileReader;l.onload=i=>{const r=i.target.result,c=new L.GPX(r,{async:!0,polyline_options:{color:"#9400D3",weight:5,opacity:.7},gpx_options:{joinTrackSegments:!1},markers:{startIcon:null,endIcon:null}});c.on("loaded",()=>{const m=c.getBounds();if(a.intersects(m)){c.addTo(e);const u=p.name.replace(/\.gpx$/i,"");t[u]=c,d.addOverlay(c,u),e.fitBounds(m)}else alert(`GPX file "${p.name}" is outside the allowed bounds and will not be displayed.`)})},l.readAsText(p)}})}function ve(e,d,t,n,a){function o(l=!1){const i=document.getElementById("map");i.classList.contains("hide-overlays")?(i.classList.remove("hide-overlays"),d.setOpacity(1)):(i.classList.toggle("hide-overlays"),d.setOpacity(l?0:1))}function p(){const l=document.querySelector(".transparency-slider");if(!l)return;const i=parseInt(l.value,10);l.value=i===100?"0":"100",l.dispatchEvent(new Event("input",{bubbles:!0}))}document.addEventListener("keydown",l=>{const i=document.activeElement;i&&(i.tagName==="INPUT"||i.tagName==="TEXTAREA"||i.isContentEditable)||(l.key.toLowerCase()==="a"?o(!0):l.key.toLowerCase()==="q"?o(!1):l.key.toLowerCase()==="s"?p():l.key==="Delete"&&(localStorage.clear(),location.reload()))})}const f=[];function xe(e){let d=null,t=!1;const n=s=>{const y=s.getZoom();return{color:"yellow",weight:Math.max(4,25-(18-y)*2),opacity:.3}},a=L.control({position:"bottomleft"});a.onAdd=function(){const s=L.DomUtil.create("div","leaflet-bar leaflet-control"),y=L.DomUtil.create("a","",s);y.href="#",y.innerHTML="🖊️",y.title="Toggle highlighter",y.style.padding="6px 10px",y.style.fontSize="20px";const g=L.DomUtil.create("a","",s);g.href="#",g.innerHTML="🧽",g.title="Clear highlights",g.style.padding="6px 10px",g.style.fontSize="20px",y.onclick=b=>{b.preventDefault(),t=!t,S()},g.onclick=b=>{b.preventDefault(),f.forEach(O=>e.removeLayer(O)),f.length=0,w()},L.DomEvent.disableClickPropagation(s),L.DomEvent.disableScrollPropagation(s);function S(){t?(y.style.background="#ff0",y.style.color="black"):(y.style.background="white",y.style.color="")}return s},a.addTo(e);function o(){e.dragging.disable(),e.doubleClickZoom.disable(),e.boxZoom.disable(),e.scrollWheelZoom.disable()}function p(){e.dragging.enable(),e.doubleClickZoom.enable(),e.boxZoom.enable(),e.scrollWheelZoom.enable()}function l(s){return s.latlng?s.latlng:s.touches&&s.touches.length>0?e.containerPointToLatLng(e.mouseEventToContainerPoint(s.touches[0])):null}function i(s){if(!t)return;const y=l(s);y&&(o(),d=L.polyline([y],n(e)).addTo(e),f.push(d),s.preventDefault&&s.preventDefault())}function r(s){if(!t||!d)return;const y=l(s);y&&(d.addLatLng(y),s.preventDefault&&s.preventDefault())}function c(s){t&&d&&(d=null,t=!1,u(),w(),p()),s.preventDefault&&s.preventDefault()}e.on("mousedown",i),e.on("mousemove",r),e.on("mouseup",c);const m=e.getContainer();m.addEventListener("touchstart",i,{passive:!0}),m.addEventListener("touchmove",r,{passive:!0}),m.addEventListener("touchend",c,{passive:!0}),e.on("zoomend",()=>{f.forEach(s=>s.setStyle(n(e)))}),window.addEventListener("keydown",s=>{if(s.key.toLowerCase()==="d"&&(t=!t,u()),(s.ctrlKey||s.metaKey)&&s.key.toLowerCase()==="z"&&f.length>0){const y=f.pop();e.removeLayer(y),w()}});function u(){const s=document.querySelector('.leaflet-bar a[title="Toggle highlighter"]');s&&(t?(s.style.background="#ff0",s.style.color="black"):(s.style.background="white",s.style.color=""))}function w(){if(!f.length){T(null);return}const s=f.map(y=>polyline.encode(y.getLatLngs().map(g=>[g.lat,g.lng]))).join(";");T(s)}function T(s){const y=new URLSearchParams(window.location.search);s?y.set("data",s):y.delete("data");const g=window.location.pathname+(y.toString()?"?"+y.toString():"")+window.location.hash;window.history.replaceState(null,"",g)}function z(){const y=new URLSearchParams(window.location.search).get("data");if(!y)return;y.split(";").forEach(S=>{try{const b=polyline.decode(S).map(([W,P])=>L.latLng(W,P)),O=L.polyline(b,n(e)).addTo(e);f.push(O)}catch{console.warn("Invalid polyline segment:",S)}})}z()}document.addEventListener("DOMContentLoaded",()=>{C()&&(document.title="🤖"+document.title);const{map:e,mainOverlay:d,baseLayers:t,satelliteLayers:n,overlays:a,currentBaseLayer:o,layersControl:p}=de();ge(e),fe(e,t,o),ve(e,d,a,t["Google Satellite"]),xe(e),he(e,p,a),ce(e,d,a,n),window.addEventListener("load",M),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&M()})});
